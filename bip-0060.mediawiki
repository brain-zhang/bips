<pre>
  BIP: 60
  层: 节点服务
  标题: 定长 "version" 消息 (转发交易控制字段)
  作者: Amir Taaki <genjix@riseup.net>
  评论-总结: 不鼓励执行 (1人)
  Comments-URI: https://github.com/bitcoin/bips/wiki/Comments:BIP-0060
  状态: 草案
  类型: 标准追踪
  创建时间: 2013-06-16
  许可: PD
</pre>

==摘要==

[[BIP 0037]] 为版本消息引入了一个新标志，表示是否将新的交易消息转发给该节点。

这个协议版本升级到70001，并已经作为BIP 0037实现了(现在已被接受)。

目前的实现是有点问题的，因为RelayTransaction标志是表示版本的消息流的可选部分。

==动机==

比特币消息的一个属性是，字段数目是固定的。这使格式简单，容易理解。在消息中添加可选字段会导致反序列化问题，因为其他字段会出现在可选字段之后。

例如，可以检查版本消息的长度，以确保字节流是一致的。对于可选字段，就不太可能进行这种检查。这有助于检查内部反序列化代码的一致性。以及对来自其他节点的版本消息进行适当的格式化。在未来，随着比特币网络的多样化，强制这种严格遵循每个协议版本的字段长度的标准消息将成为可取的。

规定消息有固定数目的字段，另一个属性是能够将流操作符传递给其他操作符进行反序列化。因为反序列化代码必须知道剩余要解析的字节的长度。解析器需要额外的信息(流的剩余大小)来进行解析，而不能对此一无所知。此属性在反序列化后也将丢失.

==规范==
=== 版本 ===

当节点创建对外连接时，它将立即发布其当前的版本消息。远程节点将使用其版本消息进行相应。在双方交换各自的版本信息之前，不能进行进一步通信。

Payload:

{|class="wikitable"
! 字段长度 !! 描述 !! 数据类型 !! 说明
|-
| 4 || version || int32_t || 标识节点使用的协议版本
|-
| 8 || services || uint64_t || 要为此连接启用的功能的位域
|-
| 8 || timestamp || int64_t || 标准UNIX时间戳(以秒为单位)
|-
| 26 || addr_recv || net_addr || 接受此消息的节点网络地址
|-
|colspan="4"| version >= 106
|-
| 26 || addr_from || net_addr || 发送此消息的节点的网络地址
|-
| 8 || nonce || uint64_t || 节点随机nonce,在每次发送一个版本包时随机生成。nonce用于检测与自身的连接状态
|-
| ? || user_agent || var_str || [[bip-0014.mediawiki|User Agent]] (如果字符串是0字节，则置为0x00 )
|-
| 4 || start_height || int32_t || 发送节点接收到的最后一个块编号
|-
| 1 || relay || bool || 远端节点是否应该声明中继交易，请参阅BIP 0037，当 version >= 70001的时候有效
|}

如果版本消息被接受，将发送一个"verack""包

目前分配的服务如下：

{|class="wikitable"
! Value !! Name !! Description
|-
| 1 || NODE_NETWORK || 这个节点可以请求完成的区块，而不仅仅是区块头
|}

=== 代码更新 ===

fRelayTx 添加到 PushMessage() 调用 PushVersion() 的部分 (net.cpp)

<pre>
void CNode::PushVersion()
{
    /// when NTP implemented, change to just nTime = GetAdjustedTime()
    int64 nTime = (fInbound ? GetAdjustedTime() : GetTime());
    CAddress addrYou = (addr.IsRoutable() && !IsProxy(addr) ? addr : CAddress(CService("0.0.0.0",0)));
    CAddress addrMe = GetLocalAddress(&addr);
    RAND_bytes((unsigned char*)&nLocalHostNonce, sizeof(nLocalHostNonce));
    printf("send version message: version %d, blocks=%d, us=%s, them=%s, peer=%s\n", PROTOCOL_VERSION, nBestHeight, addrMe.ToString().c_str(), addrYou.ToString().c_str(), addr.ToString().c_str());
    PushMessage("version", PROTOCOL_VERSION, nLocalServices, nTime, addrYou, addrMe,
                nLocalHostNonce, FormatSubVersion(CLIENT_NAME, CLIENT_VERSION, std::vector<string>()),
                nBestHeight, true);
}
</pre>

另外，协议版本要从70001增加到70002

==版权信息==

公开文档

